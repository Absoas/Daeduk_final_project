package kr.or.ddit.common.board.freeboard.service;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;

import javax.annotation.PostConstruct;
import javax.inject.Inject;

import org.apache.commons.io.FileUtils;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import kr.or.ddit.ServiceResult;
import kr.or.ddit.common.board.BoardException;
import kr.or.ddit.common.board.freeboard.dao.IFreeFileDAO;
import kr.or.ddit.common.board.freeboard.dao.IFreeboardDAO;
import kr.or.ddit.vo.Free_FileVO;
import kr.or.ddit.vo.FreeboardVO;
import kr.or.ddit.vo.PagingInfoVO;
import kr.or.ddit.vo.PersonVO;

@Service
public class FreeboardServiceImpl implements IFreeboardService{
	
	@Inject
	IFreeboardDAO boardDAO;
	@Inject
	IFreeFileDAO fileDAO;
	
	@Value("#{appInfo.pdsPath}")
	File saveFolder;
	
	@PostConstruct
	public void init(){
		if(!saveFolder.exists()) saveFolder.mkdirs();
	}
	
	private int processFiles(FreeboardVO freeVO){
		int rowCnt = 0;
		List<Free_FileVO> freeFileList = freeVO.getFreeFileList();
		
		if(freeFileList != null && freeFileList.size() > 0){
			rowCnt += fileDAO.insertFileList(freeVO);
			for(Free_FileVO freeFile : freeFileList){
				try(
					InputStream in = freeFile.getItem().getInputStream();	
				){
					FileUtils.copyInputStreamToFile(in, 
							new File(saveFolder, freeFile.getBoard_file_savename()));
				} catch(IOException e){
				}
			}
		}
		Long[] delFiles = freeVO.getDelFiles();
		if(delFiles != null){
			String[] saveNames = new String[delFiles.length];
			for(int idx = 0; idx < delFiles.length; idx++){
				saveNames[idx] = fileDAO.selectFile(delFiles[idx]).getBoard_file_savename();
			}
			rowCnt += fileDAO.deleteFileList(freeVO);
			
			for(String savename : saveNames){
				FileUtils.deleteQuietly(new File(saveFolder, savename));
			}
		}
		return rowCnt;
	}
	
	@Override
	public List<FreeboardVO> retrieveBoardList(PagingInfoVO<FreeboardVO> pagingVO) {
		return boardDAO.selectBoardList(pagingVO);
	}

	@Override
	public long retrieveBoardCount(PagingInfoVO<FreeboardVO> pagingVO) {
		return boardDAO.selectTotalRecord(pagingVO);
	}

	@Override
	public PersonVO selectPerson(String mem_id) {
		return boardDAO.selectPerson(mem_id);
	}

	@Override
	public ServiceResult createBoard(FreeboardVO freeVO) {
		int rowCnt = boardDAO.insertBoard(freeVO);
		int check = 1;
		if(rowCnt > 0){
			if(freeVO.getFreeFileList() != null)
				check += freeVO.getFreeFileList().size();
			rowCnt += processFiles(freeVO);
		}
		ServiceResult result = ServiceResult.FAILED;
		if(rowCnt >= check){
			result = ServiceResult.OK;
		}
		return result;
	}

	@Override
	public FreeboardVO retrieveBoard(long board_no) {
		FreeboardVO freeVO = boardDAO.selectBoard(board_no);
		if(freeVO == null){
			throw new BoardException(board_no+"에 해당하는 게시글이 없습니다.");
		}
		boardDAO.incrementHit(board_no);
		return freeVO;
	}

	@Override
	public ServiceResult modifyBoard(FreeboardVO freeVO) {
		FreeboardVO savedBoard = retrieveBoard(freeVO.getBoard_no());
		PersonVO savedPerson = selectPerson(savedBoard.getMem_id());
		ServiceResult result = null;
		if(savedPerson.getPerson_pass().equals(freeVO.getBoard_pass())){
			int rowCnt = boardDAO.updateBoard(freeVO);
			int check = rowCnt;
			if(rowCnt > 0){
				if(freeVO.getFreeFileList() != null)
					check += freeVO.getFreeFileList().size();
				if(freeVO.getDelFiles() != null)
					check += freeVO.getDelFiles().length;
				rowCnt += processFiles(freeVO);
			}
			if(rowCnt >= check){
				result = ServiceResult.OK;
			} else {
				result = ServiceResult.FAILED;
			}
		} else {
			result = ServiceResult.INVALIDPASSWORD;
		}
		return result;
	}

	@Override
	public ServiceResult removeBoard(FreeboardVO freeVO) {
		FreeboardVO savedBoard = retrieveBoard(freeVO.getBoard_no());
		PersonVO savedPerson = selectPerson(savedBoard.getMem_id());
		ServiceResult result = null;
		if(savedPerson.getPerson_pass().equals(freeVO.getBoard_pass())){
			int rowCnt = boardDAO.deleteBoard(freeVO.getBoard_no());
			if(rowCnt > 0){
				try{
					List<Free_FileVO> freeFileList = savedBoard.getFreeFileList();
					if(freeFileList != null){
						for(Free_FileVO freeFile : freeFileList){
							FileUtils.deleteQuietly(new File(saveFolder, freeFile.getBoard_file_savename()));
						}
					}
				}catch(NullPointerException e){
					
				}
				result = ServiceResult.OK;
			} else {
				result = ServiceResult.FAILED;
			}
		}else {
			result = ServiceResult.INVALIDPASSWORD;
		}
		return result;
	}

	@Override
	public Free_FileVO downloadFreeFile(long freeFileNo) {
		Free_FileVO freeFile = fileDAO.selectFile(freeFileNo);
		if(freeFile == null){
			throw new BoardException(freeFileNo+"에 해당 파일이 없습니다.");
		}
		return freeFile;
	}

	@Override
	public ServiceResult rcmdBoard(long board_no) {
		FreeboardVO savedBoard = retrieveBoard(board_no);
		ServiceResult result = null;
		if(savedBoard != null){
			boardDAO.incrementRcmd(board_no);
			result = ServiceResult.OK;
		} else{
			result = ServiceResult.FAILED;
		}
		return result;
	}

	
}
